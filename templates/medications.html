{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2 class="text-teal fw-bold">üíä Medication Management</h2>
        <p class="text-muted">Track your schedule at minute-level precision.</p>
    </div>
</div>

<div class="row g-4">
    <!-- Add New Medication -->
    <div class="col-md-5">
        <div class="card h-100 sidebar-sticky">
            <div class="card-header bg-white border-bottom-0 pb-0">
                <h5 class="mb-0 fw-bold">Add New Schedule</h5>
                <p class="text-muted small">Configure precise timings.</p>
            </div>
            <div class="card-body">
                <form method="POST" id="medication-form" action="{{ url_for('medications') }}" novalidate>
                    
                    <!-- Basic Info -->
                    <div class="mb-3">
                        <label for="name" class="form-label">Medicine Name</label>
                        <input type="text" name="name" id="name" class="form-control" required placeholder="e.g. Amoxicillin" minlength="2">
                        <div class="invalid-feedback">
                            Please provide a valid medicine name.
                        </div>
                    </div>
                    
                    <!-- Dosage & Freq -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dosage" class="form-label">Dosage</label>
                            <input type="text" name="dosage" id="dosage" class="form-control" required placeholder="e.g. 500mg">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="frequency" class="form-label">Type</label>
                            <select name="frequency" id="frequency" class="form-select">
                                <option value="Daily">Daily</option>
                                <option value="Weekly">Weekly</option>
                                <option value="As Needed">As Needed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Instructions / Food Timing -->
                    <div class="mb-3">
                        <label for="instructions" class="form-label">Instructions (Optional)</label>
                        <select name="instructions" id="instructions" class="form-select">
                            <option value="">None</option>
                            <option value="Before Meal">Before Meal (Empty Stomach)</option>
                            <option value="After Meal">After Meal</option>
                            <option value="With Food">With Food</option>
                            <option value="Before Bed">Before Bed</option>
                        </select>
                    </div>

                    <!-- Dynamic Times -->
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between align-items-center">
                            Scheduled Times
                            <button type="button" class="btn btn-sm btn-outline-primary" id="add-time-btn">
                                <i data-feather="plus" style="width: 14px;"></i> Add Time
                            </button>
                        </label>
                        <div id="times-container">
                            <!-- JS adds time inputs here -->
                        </div>
                        <small class="text-muted">Select exact time (HH:MM)</small>
                    </div>

                    <!-- Dates & Duration -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" name="start_date" id="start_date" class="form-control" value="{{ now }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="duration" class="form-label">Duration (Days)</label>
                            <input type="number" name="duration" id="duration" class="form-control" value="7" min="1" required>
                        </div>
                    </div>

                    <hr>

                    <!-- Notifications -->
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="email_notification" id="email_notification">
                        <label class="form-check-label" for="email_notification">Enable Email Reminders</label>
                    </div>

                    <div class="mb-3" id="notification_email_container" style="display: none;">
                        <label for="notification_email" class="form-label">Email Address</label>
                        <input type="email" name="notification_email" id="notification_email" class="form-control" placeholder="you@example.com">
                        <div class="invalid-feedback">Valid email required for notifications.</div>
                    </div>

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" name="calendar" id="calendar">
                        <label class="form-check-label" for="calendar">
                            Sync to Google Calendar
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i data-feather="save" class="me-2"></i> Save Schedule
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Column: Today's Tasks & Report -->
    <div class="col-md-7">
        
        <!-- Today's Schedule -->
        <div class="card mb-4 border-0 shadow-sm">
            <!-- Header with Solid Color -->
            <div class="card-header text-white py-3" style="background-color: #008080;">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i data-feather="clock" class="me-2"></i>Today's Schedule</h5>
                    <span class="badge fw-bold" style="background-color: #e0f2f1; color: #008080;">{{ now }}</span>
                </div>
            </div>
            
            <!-- Scrollable List -->
            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                <div class="list-group list-group-flush">
                    {% if todays_doses %}
                        {% for dose in todays_doses %}
                        <div class="list-group-item p-3 d-flex align-items-center justify-content-between border-bottom">
                            <div class="d-flex align-items-center">
                                <div class="me-3 text-center" style="min-width: 60px;">
                                    <h5 class="mb-0 fw-bold text-dark">{{ dose.time }}</h5>
                                    <small class="text-muted badge bg-light text-dark border">{{ dose.frequency }}</small>
                                </div>
                                <div class="border-start ps-3">
                                    <h6 class="mb-0 fw-bold text-primary">{{ dose.medicine_name }}</h6>
                                    <small class="text-muted">{{ dose.dosage }}</small>
                                    {% if dose.instructions %}
                                    <div class="small text-muted fst-italic mt-1"><i data-feather="info" style="width:12px"></i> {{ dose.instructions }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div>
                                {% if dose.taken %}
                                    <span class="badge bg-success rounded-pill px-3 py-2"><i data-feather="check"></i> Taken</span>
                                {% else %}
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-success" onclick="markStatus('taken', '{{ dose.medicine_name }}', '{{ dose.time }}')" title="Mark as Taken">
                                            <i data-feather="check"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="markStatus('skipped', '{{ dose.medicine_name }}', '{{ dose.time }}')" title="Skip">
                                            <i data-feather="x"></i>
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <span class="bg-light p-3 rounded-circle">
                                    <i data-feather="sun" class="text-warning" style="width: 32px; height: 32px;"></i>
                                </span>
                            </div>
                            <h6 class="text-muted">No medications scheduled for today.</h6>
                            <small class="text-muted">Enjoy your day!</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Performance & Report -->
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0 fw-bold"><i data-feather="bar-chart-2" class="me-2"></i>Weekly Performance</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-4 border-end">
                        <h3 class="mb-0 text-teal fw-bold">{{ stats.adherence_rate }}%</h3>
                        <small class="text-muted">Adherence</small>
                    </div>
                    <div class="col-4 border-end">
                        <h3 class="mb-0 text-success fw-bold">{{ stats.taken_count }}</h3>
                        <small class="text-muted">Taken</small>
                    </div>
                    <div class="col-4">
                        <h3 class="mb-0 text-danger fw-bold">{{ stats.missed_count }}</h3>
                        <small class="text-muted">Missed</small>
                    </div>
                </div>

                <div class="bg-light p-3 rounded">
                    <label class="form-label small fw-bold text-muted">Email Report</label>
                    <div class="input-group">
                        <input type="email" id="report-email" class="form-control" placeholder="Enter your email" value="{{ user_email or '' }}">
                        <button class="btn btn-primary" onclick="sendReport()">
                            <i data-feather="send" class="me-2"></i> Send Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Active Schedules (Collapsed by default or small) -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#activeList" style="cursor: pointer;">
                <h6 class="mb-0 fw-bold text-muted">All Medication Settings</h6>
                <i data-feather="chevron-down"></i>
            </div>
            <div class="collapse show" id="activeList">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% if reminders %}
                            {% for r in reminders %}
                            <div class="list-group-item p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1 fw-bold text-teal">{{ r.medicine_name }} <span class="badge bg-light text-dark border ms-2">{{ r.dosage }}</span></h6>
                                        <div class="mt-2">
                                            {% for time in r.times %}
                                                <span class="badge bg-primary bg-opacity-10 text-primary me-1 mb-1">‚è∞ {{ time }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <span class="badge bg-light text-muted">{{ r.frequency }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-3">
                                <p class="text-muted small mb-0">No active schedules.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmActionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-4 text-center">
                    <div class="mb-3">
                        <span class="bg-light p-3 rounded-circle text-primary">
                            <i data-feather="help-circle" style="width: 32px; height: 32px;"></i>
                        </span>
                    </div>
                    <p class="mb-0 fs-5" id="confirmMsg">Are you sure?</p>
                </div>
                <div class="modal-footer border-top-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary px-4" id="confirmBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Info/Alert Modal -->
    <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body p-4 text-center">
                    <div class="mb-3">
                        <span id="infoIconContainer" class="p-3 rounded-circle d-inline-block">
                            <i id="infoIcon" data-feather="info" style="width: 32px; height: 32px;"></i>
                        </span>
                    </div>
                    <h5 class="fw-bold mb-2" id="infoTitle">Info</h5>
                    <p class="text-muted mb-4" id="infoMsg">Message</p>
                    <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">Okay</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/scheduler.js') }}"></script>
<script>
let pendingAction = null;
let confirmModal = null;
let infoModal = null;

document.addEventListener('DOMContentLoaded', function() {
    confirmModal = new bootstrap.Modal(document.getElementById('confirmActionModal'));
    infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    
    document.getElementById('confirmBtn').addEventListener('click', async () => {
        if(!pendingAction) return;
        confirmModal.hide();
        
        const { action, name, time } = pendingAction;
        
        try {
            const res = await fetch('/api/medication/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: action,
                    medicine_name: name,
                    scheduled_time: time,
                    reason: action === 'skipped' ? 'User skipped' : ''
                })
            });
            const data = await res.json();
            if(data.success) {
                location.reload();
            } else {
                showAlert('Error', data.error || 'Unknown error occurred', 'error');
            }
        } catch(e) {
            console.error(e);
            showAlert('Error', 'Failed to update status', 'error');
        }
    });
});

function showAlert(title, msg, type='error') {
    document.getElementById('infoTitle').textContent = title;
    document.getElementById('infoMsg').textContent = msg;
    const container = document.getElementById('infoIconContainer');
    const icon = document.getElementById('infoIcon');
    
    if(type === 'success') {
        container.className = "p-3 rounded-circle d-inline-block bg-success bg-opacity-10 text-success";
        icon.setAttribute('data-feather', 'check-circle');
    } else {
        container.className = "p-3 rounded-circle d-inline-block bg-danger bg-opacity-10 text-danger";
        icon.setAttribute('data-feather', 'alert-circle');
    }
    feather.replace();
    infoModal.show();
}

function markStatus(action, name, time) {
    pendingAction = { action, name, time };
    const msg = action === 'taken' 
        ? `Mark <strong>${name}</strong> as taken at ${time}?` 
        : `Skip <strong>${name}</strong> at ${time}?`;
    
    document.getElementById('confirmMsg').innerHTML = msg;
    confirmModal.show();
}

async function sendReport() {
    const email = document.getElementById('report-email').value;
    if(!email) {
        showAlert('Input Required', 'Please enter an email address', 'error');
        return;
    }

    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'Sending...';

    try {
        const res = await fetch('/api/report/email', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        });
        const data = await res.json();
        if(data.success) {
            showAlert('Success', 'Report sent successfully!', 'success');
        } else {
            showAlert('Error', data.message, 'error');
        }
    } catch(e) {
        showAlert('Error', 'Failed to send report. Please try again.', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
</script>
{% endblock %}
