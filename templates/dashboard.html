{% extends "base.html" %}

{% block content %}
<div class="row g-4">
    <!-- Sidebar: List & Upload -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title mb-4 fw-bold">ðŸ“„ Prescriptions</h5>
                
                <!-- Upload Box -->
                <!-- Upload Box -->
                <form method="POST" enctype="multipart/form-data" class="mb-4" id="uploadForm">
                    <div class="upload-area position-relative d-flex flex-column align-items-center justify-content-center">
                        <input type="file" name="prescription" class="position-absolute top-0 start-0 w-100 h-100 opacity-0" 
                               onchange="handleUpload(this)" accept=".pdf,.jpg,.jpeg,.png">
                        <div class="bg-white p-3 rounded-circle shadow-sm mb-3">
                            <i data-feather="upload-cloud" style="width: 24px; height: 24px; color: var(--primary-teal)"></i>
                        </div>
                        <h6 class="fw-bold mb-1">Upload Prescription</h6>
                        <p class="mb-0 text-muted small" style="font-size: 0.8rem;">Drag & drop or click to browse</p>
                        <small class="text-muted mt-1" style="font-size: 0.7rem;">(PDF, JPG, PNG)</small>
                    </div>
                </form>

                <!-- List -->
                <div class="list-group list-group-flush flex-grow-1 overflow-auto" style="max-height: 500px;">
                    {% if prescriptions %}
                        {% for p in prescriptions %}
                        <div class="d-flex align-items-center border-0 mb-2 rounded {% if active_p and active_p.id == p.id %}bg-light text-primary fw-bold border-start border-4 border-primary shadow-sm{% else %}bg-white border{% endif %}" style="transition: all 0.2s;">
                            <a href="{{ url_for('dashboard', view=p.id) }}" class="flex-grow-1 p-3 text-decoration-none text-reset d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">{{ p.title }}</h6>
                                    <small class="text-muted" style="font-weight: normal;">{{ p.date }}</small>
                                </div>
                                <i data-feather="chevron-right" class="text-muted ms-2" style="width: 16px;"></i>
                            </a>
                            <button class="btn btn-link text-danger p-3" 
                                    data-id="{{ p.id }}"
                                    data-title="{{ p.title }}"
                                    onclick="confirmDelete(event, this)" 
                                    title="Delete Chat">
                                <i data-feather="trash-2" style="width: 16px;"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <p>No prescriptions found.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content: Details or Empty State -->
    <div class="col-md-8">
        {% if active_p %}
        <div class="card h-100">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-teal">{{ active_p.title }}</h5>
                    <span class="badge bg-light text-dark">{{ active_p.id[:8] }}...</span>
                </div>
            </div>
            
            <div class="card-body p-0 d-flex flex-column" style="height: 75vh; min-height: 500px;">
                <!-- Split View: Top Details, Bottom Chat -->
                
                <!-- Top: Details (Collapsible/Scrollable) -->
                <!-- Top: Details (Collapsible/Scrollable) -->
                <div class="border-bottom bg-light" style="flex: 0 0 auto; max-height: 40vh; overflow-y: auto;">
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold text-teal mb-0"><i data-feather="list" class="me-2"></i>Prescribed Medicines</h6>
                        </div>
                        
                        {% if active_p.med_list %}
                            <div class="row g-2">
                                {% for med in active_p.med_list %}
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body p-3 d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-teal bg-opacity-10 p-2 rounded-circle me-3 text-teal">
                                                    <i data-feather="activity" style="width: 18px; height: 18px;"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 fw-bold text-dark">{{ med.name_dosage }}
                                                        {% if med.frequency %}
                                                            <span class="badge bg-secondary ms-2" style="font-size: 0.75rem;">{{ med.frequency }}</span>
                                                        {% endif %}
                                                    </h6>
                                                    {% if med.timing %}
                                                    <div class="mt-1">
                                                        {% if med.timing.M != '0' %}<span class="badge bg-warning text-dark me-1">Morning: {{ med.timing.M }}</span>{% endif %}
                                                        {% if med.timing.A != '0' %}<span class="badge bg-orange text-white me-1" style="background-color: #fd7e14;">Afternoon: {{ med.timing.A }}</span>{% endif %}
                                                        {% if med.timing.N != '0' %}<span class="badge bg-indigo text-white me-1" style="background-color: #6610f2;">Night: {{ med.timing.N }}</span>{% endif %}

                                                        {% if med.timing.I and med.timing.I != '' %}<span class="badge bg-info text-dark">{{ med.timing.I.replace('_', ' ') }}</span>{% endif %}
                                                        {% if med.timing.C and med.timing.C != '' %}
                                                            <div class="mt-2">
                                                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">
                                                                    <i data-feather="alert-triangle" style="width: 12px; height: 12px; vertical-align: middle;"></i> 
                                                                    Caution: {{ med.timing.C.replace('_', ' ') }}
                                                                </span>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="bg-white p-3 rounded border font-monospace small text-muted">
                                {{ active_p.details or 'No details available.' }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Bottom: Chat Interface -->
                <div class="d-flex flex-column flex-grow-1" style="min-height: 0;">
                    <div class="p-2 border-bottom bg-white d-flex justify-content-between align-items-center shadow-sm" style="z-index: 10;">
                        <h6 class="fw-bold text-teal mb-0 ps-2"><i data-feather="message-square" class="me-2"></i>AI Assistant</h6>
                        <button class="btn btn-sm btn-outline-danger border-0" 
                                data-id="{{ active_p.id }}"
                                data-title="{{ active_p.title }}"
                                onclick="confirmDelete(event, this)" 
                                title="Delete Chat">
                            <i data-feather="trash-2" style="width: 16px;"></i>
                        </button>
                    </div>

                    <!-- Messages -->
                    <div class="flex-grow-1 overflow-auto p-3" id="chat-box">
                        {% for msg in chat_history %}
                        <div class="message {{ msg.role }}">
                            {{ msg.content }}
                        </div>
                        {% endfor %}
                    </div>
                    
                    </div>
                    
                    </div>
                    
                    <!-- Availability Toggle -->
                    <div class="px-3 pb-2 bg-light">
                        <div class="form-check form-switch d-flex align-items-center justify-content-between p-2 rounded border bg-white">
                            <label class="form-check-label fw-bold small text-muted mb-0" for="availabilityToggle">
                                <i data-feather="shopping-bag" style="width: 14px;" class="me-1"></i> Check Local Availability
                            </label>
                            <input class="form-check-input ms-0" type="checkbox" id="availabilityToggle" onchange="toggleAvailability(this)">
                        </div>
                    </div>

                    <!-- Input -->
                    <div class="p-3 bg-light border-top">
                        <div class="input-group">
                            <input type="text" id="chat-input" class="form-control border-0 shadow-sm" placeholder="Ask about this prescription...">
                            <button class="btn btn-primary px-4" onclick="sendChat('{{ active_p.id }}')">
                                <i data-feather="send"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card h-100 d-flex align-items-center justify-content-center text-center p-5">
            <div class="text-muted">
                <div style="font-size: 4rem; opacity: 0.3;">ðŸ“‹</div>
                <h3 class="mt-3">Select a Prescription</h3>
                <p>Upload new or select existing to view details & chat.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
    <!-- Confirm/Delete Modal -->
    <div class="modal fade" id="confirmActionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body py-4 text-center">
                    <div class="mb-3">
                        <span class="bg-light p-3 rounded-circle text-danger">
                            <i data-feather="trash-2" style="width: 32px; height: 32px;"></i>
                        </span>
                    </div>
                    <h5 class="fw-bold mb-2">Delete Chat?</h5>
                    <p class="text-muted mb-4" id="confirmMsg">Are you sure you want to delete this?</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger px-4" id="confirmDeleteBtn">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info/Alert Modal -->
    <div class="modal fade" id="infoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body p-4 text-center">
                    <div class="mb-3">
                        <span id="infoIconContainer" class="p-3 rounded-circle d-inline-block">
                            <i id="infoIcon" data-feather="info" style="width: 32px; height: 32px;"></i>
                        </span>
                    </div>
                    <h5 class="fw-bold mb-2" id="infoTitle">Info</h5>
                    <p class="text-muted mb-4" id="infoMsg">Message</p>
                    <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">Okay</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let infoModal = null;
let confirmModal = null;
let pendingDeleteId = null;

document.addEventListener('DOMContentLoaded', () => {
    // Check if element exists before init
    const infoModalEl = document.getElementById('infoModal');
    if(infoModalEl) infoModal = new bootstrap.Modal(infoModalEl);
    
    const confirmModalEl = document.getElementById('confirmActionModal');
    if(confirmModalEl) {
        confirmModal = new bootstrap.Modal(confirmModalEl);
        
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if(!pendingDeleteId) return;
            
            // Show loading state
            const btn = document.getElementById('confirmDeleteBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Deleting...';
            btn.disabled = true;

            try {
                console.log("Deleting ID:", pendingDeleteId);
                const res = await fetch('/api/prescription/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: pendingDeleteId})
                });
                
                // If 404 (not found) or 204 (no content), treat as success
                if (res.status === 404 || res.status === 204) {
                    window.location.href = '/dashboard';
                    return;
                }

                let data = {};
                try {
                    const text = await res.text();
                    if(text) data = JSON.parse(text);
                } catch (jsonErr) {
                    console.warn("Invalid JSON response", jsonErr);
                }

                if(res.ok && (data.success || !data.error)) {
                    window.location.href = '/dashboard';
                } else {
                    confirmModal.hide();
                    showAlert('Error', data.error || 'Operation failed (Status ' + res.status + ')');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch(e) {
                console.error("Delete failed:", e);
                confirmModal.hide();
                showAlert('Error', 'Operation failed: ' + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
    }
});

function confirmDelete(e, btn) {
    if (!btn) return;
    e.preventDefault(); 
    e.stopPropagation();
    
    // Get data from attributes to avoid quote escaping issues
    const id = btn.getAttribute('data-id');
    const title = btn.getAttribute('data-title') || 'Prescription';
    
    pendingDeleteId = id;
    document.getElementById('confirmMsg').innerHTML = `Delete <strong>${title}</strong> and all history?`;
    confirmModal.show();
}

function showAlert(title, msg, type='error') {
    if(!infoModal) return; 
    
    document.getElementById('infoTitle').textContent = title;
    document.getElementById('infoMsg').textContent = msg;
    const container = document.getElementById('infoIconContainer');
    const icon = document.getElementById('infoIcon');
    
    if(type === 'success') {
        container.className = "p-3 rounded-circle d-inline-block bg-success bg-opacity-10 text-success";
        icon.setAttribute('data-feather', 'check-circle');
    } else {
        container.className = "p-3 rounded-circle d-inline-block bg-danger bg-opacity-10 text-danger";
        icon.setAttribute('data-feather', 'alert-circle');
    }
    feather.replace();
    infoModal.show();
}

async function sendChat(pid) {
    const input = document.getElementById('chat-input');
    const box = document.getElementById('chat-box');
    const msg = input.value.trim();
    if(!msg) return;

    // Add user msg
    box.innerHTML += `<div class="message user">${msg}</div>`;
    input.value = '';
    box.scrollTop = box.scrollHeight;

    // Loading
    const loadId = 'loading-' + Date.now();
    box.innerHTML += `<div class="message ai text-muted fst-italic" id="${loadId}">Thinking...</div>`;
    box.scrollTop = box.scrollHeight;

    try {
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: msg, prescription_id: pid})
        });
        const data = await res.json();
        
        document.getElementById(loadId).remove();
        box.innerHTML += `<div class="message ai">${data.answer || 'Error'}</div>`;
        box.scrollTop = box.scrollHeight;
    } catch(e) {
        document.getElementById(loadId).remove();
        console.error(e);
        showAlert('Connection Error', 'Failed to send message. Please check your connection.', 'error');
    }
}

document.getElementById('chat-input')?.addEventListener('keypress', e => {
    if(e.key === 'Enter') sendChat('{{ active_p.id if active_p else "" }}');
});

function handleUpload(input) {
    if (input.files && input.files[0]) {
        // Show global loader with analyzing message
        showLoader("Analyzing Prescription", "Extracting medicines and details...");
        document.getElementById('uploadForm').submit();
    }
}

function setChatMsg(msg) {
    const input = document.getElementById('chat-input');
    if(input) {
        input.value = msg;
        input.focus();
        sendChat('{{ active_p.id if active_p else "" }}');
    }
}

function toggleAvailability(checkbox) {
    if(checkbox.checked) {
        setChatMsg('Check if these medicines are typically available in local medical shops.');
        // Optional: Reset checkbox after a delay or keep it to show state
        setTimeout(() => { checkbox.checked = false; }, 2000); 
    }
}
</script>
{% endblock %}
