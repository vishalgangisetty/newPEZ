{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    #map { height: 100%; min-height: 500px; border-radius: 12px; z-index: 1; }
    .leaflet-popup-content-wrapper { border-radius: 8px; font-family: 'Inter', sans-serif; }
    .leaflet-popup-content h6 { margin-bottom: 5px; color: var(--primary-teal); font-weight: 700; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2 class="text-teal fw-bold">üè• Pharmacy Locator</h2>
        <p class="text-muted">Find nearby pharmacies tailored to your prescription.</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="fw-bold mb-3">Search Area</h5>
                <form id="searchForm">
                    <!-- Radius Setting -->
                    <div class="mb-3">
                        <label class="form-label">Search Radius</label>
                        <select id="radius" class="form-select">
                            <option value="1000">1 km</option>
                            <option value="5000" selected>5 km</option>
                            <option value="10000">10 km</option>
                        </select>
                    </div>

                    <!-- Manual Search Section -->
                    <div class="mb-3">
                        <label class="form-label">Search by Address</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i data-feather="search" style="width: 16px;"></i></span>
                            <input type="text" id="locationInput" class="form-control" placeholder="Enter city or area...">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100" onclick="event.preventDefault(); searchLocation()">
                        Search Location
                    </button>

                    <!-- OR Separator -->
                    <div class="text-center position-relative my-4">
                        <hr class="m-0 text-muted opacity-25">
                        <span class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted small fw-bold">OR</span>
                    </div>

                    <!-- GPS Section -->
                    <button type="button" class="btn btn-outline-primary w-100 py-2 border-2" onclick="searchGPS()">
                        <i data-feather="crosshair" class="me-2"></i> Use Current GPS Location
                    </button>
                    
                    <div id="status" class="mt-3 text-center small text-muted"></div>
                </form>
                
                <hr>
                
                <div id="resultsList" class="list-group list-group-flush overflow-auto" style="max-height: 400px;">
                    <!-- Results populated by JS -->
                    <div class="text-center text-muted py-4">
                        <i data-feather="map" style="width: 32px; height: 32px; opacity: 0.2;"></i>
                        <p class="mt-2 small">Enter a location or use GPS to find pharmacies.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card shadow-sm" style="height: 75vh; min-height: 500px;">
            <div class="card-body p-0">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>

<!-- GPS Prompt Modal -->
<div class="modal fade" id="gpsPromptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <span class="bg-light p-3 rounded-circle text-primary">
                        <i data-feather="navigation" style="width: 24px; height: 24px;"></i>
                    </span>
                </div>
                <h5 class="fw-bold mb-2">Use Current Location?</h5>
                <p class="text-muted mb-4">You haven't entered a specific location. Would you like to use your device's GPS instead?</p>
                <div class="d-flex justify-content-center gap-2">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">No, thanks</button>
                    <button type="button" class="btn btn-primary px-4" id="useGpsBtn">Yes, Use GPS</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
let map = null;
let markers = [];
let userMarker = null;

function initMap() {
    map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
}

document.addEventListener('DOMContentLoaded', () => {
    initMap();
    
    // Initialize GPS Modal
    const gpsModalEl = document.getElementById('gpsPromptModal');
    if (gpsModalEl) {
        const gpsModal = new bootstrap.Modal(gpsModalEl);
        
        document.getElementById('useGpsBtn').addEventListener('click', () => {
            gpsModal.hide();
            searchGPS();
        });
        
        // Expose to global scope so searchLocation can use it
        window.gpsPromptModal = gpsModal;
    }
});

// Allow Enter key to trigger search
document.getElementById('locationInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchLocation();
    }
});

function searchGPS() {
    const status = document.getElementById('status');
    if (!navigator.geolocation) {
        status.textContent = "Geolocation not supported.";
        return;
    }
    status.textContent = "Locating...";
    navigator.geolocation.getCurrentPosition(pos => {
        executeSearch({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
        });
    }, () => {
        status.textContent = "Location access denied.";
    });
}

function searchLocation() {
    const loc = document.getElementById('locationInput').value.trim();
    if (!loc) {
        if (window.gpsPromptModal) {
            window.gpsPromptModal.show();
        } else {
            // Fallback if modal fails to init
            if(confirm("No location entered. Use GPS instead?")) searchGPS();
        }
        return;
    }
    executeSearch({ location: loc });
}

async function executeSearch(payload) {
    const status = document.getElementById('status');
    const radius = document.getElementById('radius').value;
    const list = document.getElementById('resultsList');
    
    payload.radius = radius;
    status.textContent = "Searching...";
    
    try {
        const res = await fetch('/api/pharmacy/search', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Search failed');
        }
        
        const data = await res.json();
        const results = data.results || [];
        const center = data.center;

        // Update Map Center
        if (center) {
            map.setView([center.lat, center.lng], 14);
            // Add user/search location marker
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker([center.lat, center.lng]).addTo(map)
                .bindPopup("<b>Search Location</b>").openPopup();
        }

        // Clear Results
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        list.innerHTML = '';

        if (results.length > 0) {
            const bounds = L.latLngBounds();
            if(center) bounds.extend([center.lat, center.lng]);

            results.forEach(p => {
                // Determine origin for navigation
                let originParam = '';
                if (center) {
                    originParam = `&origin=${center.lat},${center.lng}`;
                }

                // List Item
                list.innerHTML += `
                <div class="list-group-item list-group-item-action" onclick="focusOnMap(${p.latitude}, ${p.longitude})" style="cursor: pointer;">
                    <div class="d-flex justify-content-between">
                        <h6 class="mb-1 fw-bold text-teal">${p.name}</h6>
                        <small class="text-muted">${(p.distance / 1000).toFixed(1)} km</small>
                    </div>
                    <div class="mt-1 text-muted small">
                        <i data-feather="map-pin" style="width: 12px;"></i> ${p.address}
                    </div>
                    <div class="mt-2">
                         <a href="https://www.google.com/maps/dir/?api=1${originParam}&destination=${p.latitude},${p.longitude}" target="_blank" class="btn btn-outline-primary btn-sm py-0" style="font-size: 0.75rem;">
                            <i data-feather="navigation" style="width:12px"></i> Navigate
                        </a>
                    </div>
                </div>`;

                // Map Marker
                const marker = L.marker([p.latitude, p.longitude]).addTo(map)
                    .bindPopup(`
                        <h6>${p.name}</h6>
                        <p class="mb-1 small">${p.address}</p>
                        <a href="https://www.google.com/maps/dir/?api=1${originParam}&destination=${p.latitude},${p.longitude}" target="_blank" class="btn btn-primary btn-sm w-100 mt-2">Navigate</a>
                    `);
                markers.push(marker);
                bounds.extend([p.latitude, p.longitude]);
            });
            
            feather.replace();
            if(!center) map.fitBounds(bounds, {padding: [50, 50]});
            status.textContent = `Found ${results.length} pharmacies.`;
        } else {
            list.innerHTML = '<div class="text-center p-4 text-muted">No pharmacies found in this area.</div>';
            status.textContent = "No results found.";
        }
        
    } catch (e) {
        console.error(e);
        status.textContent = e.message;
    }
}

function focusOnMap(lat, lng) {
    map.setView([lat, lng], 16);
    // Find approximate marker to open popup
    markers.forEach(m => {
        const mLat = m.getLatLng().lat;
        const mLng = m.getLatLng().lng;
        if (Math.abs(mLat - lat) < 0.0001 && Math.abs(mLng - lng) < 0.0001) {
            m.openPopup();
        }
    });
}
</script>
{% endblock %}
